generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model Achievement {
  id              String            @id @default(cuid())
  code            String            @unique
  name            String
  description     String
  points          Int               @default(0)
  rewardId        String?
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt
  Reward          Reward?           @relation(fields: [rewardId], references: [id])
  UserAchievement UserAchievement[]

  @@index([code])
}

model Activity {
  id         String   @id @default(cuid())
  profileId  String
  type       String
  payload    Json
  visibility String   @default("public")
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  User       User     @relation(fields: [profileId], references: [id], onDelete: Cascade)

  @@index([createdAt])
  @@index([profileId])
  @@index([type])
  @@index([visibility])
}

model Appraisal {
  id          String         @id @default(cuid())
  commentId   String
  voterId     String
  value       AppraisalValue
  createdAt   DateTime       @default(now())
  updatedAt   DateTime       @updatedAt
  CommentMark CommentMark    @relation(fields: [commentId], references: [id])
  User        User           @relation(fields: [voterId], references: [id])

  @@unique([commentId, voterId])
  @@index([voterId])
}

model AvatarConfiguration {
  id                       String                    @id @default(cuid())
  userId                   String
  configurationData        Json
  exportFormat             String?
  qualityPreset            String?
  celShadingConfig         Json?
  physicsConfig            Json?
  nsfwAnatomyConfig        Json?
  advancedMaterialSettings Json?
  createdAt                DateTime                  @default(now())
  updatedAt                DateTime                  @updatedAt
  User                     User                      @relation(fields: [userId], references: [id], onDelete: Cascade)
  AvatarConfigurationPart  AvatarConfigurationPart[]
  AvatarMaterialOverride   AvatarMaterialOverride[]
  AvatarMorphTarget        AvatarMorphTarget[]

  @@index([userId])
}

model AvatarConfigurationPart {
  id                  String              @id @default(cuid())
  configurationId     String
  partId              String
  partType            String
  attachmentOrder     Int
  createdAt           DateTime            @default(now())
  updatedAt           DateTime            @updatedAt
  AvatarConfiguration AvatarConfiguration @relation(fields: [configurationId], references: [id], onDelete: Cascade)

  @@unique([configurationId, attachmentOrder])
  @@index([configurationId])
}

model AvatarMaterialOverride {
  id                  String              @id @default(cuid())
  configurationId     String
  slot                String
  type                String
  value               Json
  opacity             Float?
  createdAt           DateTime            @default(now())
  updatedAt           DateTime            @updatedAt
  AvatarConfiguration AvatarConfiguration @relation(fields: [configurationId], references: [id], onDelete: Cascade)

  @@unique([configurationId, slot])
  @@index([configurationId])
}

model AvatarMorphTarget {
  id                  String              @id @default(cuid())
  configurationId     String
  targetName          String
  value               Float
  createdAt           DateTime            @default(now())
  updatedAt           DateTime            @updatedAt
  AvatarConfiguration AvatarConfiguration @relation(fields: [configurationId], references: [id], onDelete: Cascade)

  @@unique([configurationId, targetName])
  @@index([configurationId])
}

model Block {
  blockerId                  String
  blockedId                  String
  createdAt                  DateTime @default(now())
  User_Block_blockedIdToUser User     @relation("Block_blockedIdToUser", fields: [blockedId], references: [id], onDelete: Cascade)
  User_Block_blockerIdToUser User     @relation("Block_blockerIdToUser", fields: [blockerId], references: [id], onDelete: Cascade)

  @@id([blockerId, blockedId])
  @@index([blockedId])
  @@index([blockerId])
}

model Cart {
  id        String     @id @default(cuid())
  userId    String     @unique
  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt
  User      User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  CartItem  CartItem[]

  @@index([userId])
}

model CartItem {
  id               String         @id @default(cuid())
  cartId           String
  productId        String
  productVariantId String
  quantity         Int            @default(1)
  createdAt        DateTime       @default(now())
  updatedAt        DateTime       @updatedAt
  Cart             Cart           @relation(fields: [cartId], references: [id], onDelete: Cascade)
  Product          Product        @relation(fields: [productId], references: [id])
  ProductVariant   ProductVariant @relation(fields: [productVariantId], references: [id])

  @@unique([cartId, productId, productVariantId])
  @@index([cartId])
  @@index([productId])
  @@index([productVariantId])
}

model CharacterConfig {
  id                String              @id @default(cuid())
  userId            String
  name              String
  isActive          Boolean             @default(false)
  configData        Json
  meshData          Json
  textureData       Json
  createdAt         DateTime            @default(now())
  updatedAt         DateTime            @updatedAt
  User              User                @relation(fields: [userId], references: [id], onDelete: Cascade)
  CharacterReaction CharacterReaction[]

  @@unique([userId, isActive], map: "CharacterConfig_userId_isActive_unique")
  @@index([isActive])
  @@index([userId])
}

model CharacterPreset {
  id                  String                @id @default(cuid())
  name                String
  description         String?
  category            String
  meshData            Json
  textureData         Json
  colorPalette        Json
  configData          Json? // Full AvatarConfiguration JSON
  rarity              String                @default("common")
  unlockCondition     Json?
  isDefault           Boolean               @default(false)
  createdAt           DateTime              @default(now())
  updatedAt           DateTime              @updatedAt
  UserCharacterPreset UserCharacterPreset[]

  @@index([category])
  @@index([rarity])
}

model AvatarQualityPreset {
  id                    String   @id @default(cuid())
  name                  String
  description           String?
  textureSize           Int      @default(2048)
  shadowMapSize         Int      @default(4096)
  samples               Int      @default(4)
  enablePhysics         Boolean  @default(true)
  enableAdvancedShaders Boolean  @default(true)
  celShadingSteps       Int      @default(3)
  rimLightIntensity     Float    @default(0.5)
  isDefault             Boolean  @default(false)
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt

  @@index([isDefault])
}

model CharacterReaction {
  id                String          @id @default(cuid())
  characterConfigId String
  context           String
  reactionType      String
  animationData     Json
  triggerConditions Json?
  createdAt         DateTime        @default(now())
  updatedAt         DateTime        @updatedAt
  CharacterConfig   CharacterConfig @relation(fields: [characterConfigId], references: [id], onDelete: Cascade)

  @@index([characterConfigId])
  @@index([context])
}

model Comment {
  id               String          @id @default(cuid())
  content          String
  authorId         String
  parentId         String?
  contentType      String
  contentId        String
  isDeleted        Boolean         @default(false)
  isModerated      Boolean         @default(false)
  moderationReason String?
  likeCount        Int             @default(0)
  replyCount       Int             @default(0)
  createdAt        DateTime        @default(now())
  updatedAt        DateTime        @updatedAt
  User             User            @relation(fields: [authorId], references: [id], onDelete: Cascade)
  Comment          Comment?        @relation("CommentToComment", fields: [parentId], references: [id], onDelete: Cascade)
  other_Comment    Comment[]       @relation("CommentToComment")
  CommentLike      CommentLike[]
  CommentReport    CommentReport[]

  @@index([authorId])
  @@index([contentType, contentId])
  @@index([createdAt])
  @@index([isDeleted])
  @@index([isModerated])
  @@index([parentId])
}

model CommentFragment {
  id          String      @id @default(cuid())
  commentId   String
  phraseId    String
  position    Int
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt
  CommentMark CommentMark @relation(fields: [commentId], references: [id])
  Phrase      Phrase      @relation(fields: [phraseId], references: [id])

  @@unique([commentId, position])
  @@index([phraseId])
}

model CommentLike {
  id        String   @id @default(cuid())
  commentId String
  userId    String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  Comment   Comment  @relation(fields: [commentId], references: [id], onDelete: Cascade)
  User      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([commentId, userId])
  @@index([commentId])
  @@index([userId])
}

model CommentMark {
  id                String              @id @default(cuid())
  postId            String?
  parentId          String?
  authorId          String
  kind              CommentKind
  text              String?             @db.VarChar(180)
  goodCount         Int                 @default(0)
  poorCount         Int                 @default(0)
  score             Int                 @default(0)
  status            CommentStatus       @default(ACTIVE)
  metadata          Json?
  createdAt         DateTime            @default(now())
  updatedAt         DateTime            @updatedAt
  Appraisal         Appraisal[]
  CommentFragment   CommentFragment[]
  User              User                @relation(fields: [authorId], references: [id])
  CommentMark       CommentMark?        @relation("CommentMarkToCommentMark", fields: [parentId], references: [id])
  other_CommentMark CommentMark[]       @relation("CommentMarkToCommentMark")
  Post              Post?               @relation(fields: [postId], references: [id])
  CommentModeration CommentModeration[]

  @@index([authorId, createdAt])
  @@index([parentId])
  @@index([postId, status, createdAt])
}

model CommentModeration {
  id          String      @id @default(cuid())
  commentId   String
  moderatorId String?
  action      String
  reason      String?
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt
  CommentMark CommentMark @relation(fields: [commentId], references: [id])
  User        User?       @relation(fields: [moderatorId], references: [id])

  @@index([commentId, createdAt])
}

model CommentReport {
  id                                   String    @id @default(cuid())
  commentId                            String
  reporterId                           String
  reason                               String
  description                          String?
  status                               String    @default("pending")
  moderatorId                          String?
  moderatorNotes                       String?
  createdAt                            DateTime  @default(now())
  updatedAt                            DateTime  @updatedAt
  resolvedAt                           DateTime?
  Comment                              Comment   @relation(fields: [commentId], references: [id], onDelete: Cascade)
  User_CommentReport_moderatorIdToUser User?     @relation("CommentReport_moderatorIdToUser", fields: [moderatorId], references: [id])
  User_CommentReport_reporterIdToUser  User      @relation("CommentReport_reporterIdToUser", fields: [reporterId], references: [id], onDelete: Cascade)

  @@unique([commentId, reporterId])
  @@index([commentId])
  @@index([reporterId])
  @@index([status])
}

model ContactMessage {
  id        String   @id @default(cuid())
  name      String
  email     String
  message   String
  imageUrl  String?
  userId    String?
  read      Boolean  @default(false)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  User      User?    @relation(fields: [userId], references: [id])
}

model ContentModeration {
  id                                       String    @id @default(cuid())
  contentType                              String
  contentId                                String
  content                                  String
  authorId                                 String
  status                                   String    @default("pending")
  automatedScore                           Decimal?
  moderatorId                              String?
  moderatorNotes                           String?
  flags                                    Json?
  createdAt                                DateTime  @default(now())
  updatedAt                                DateTime  @updatedAt
  reviewedAt                               DateTime?
  User_ContentModeration_authorIdToUser    User      @relation("ContentModeration_authorIdToUser", fields: [authorId], references: [id], onDelete: Cascade)
  User_ContentModeration_moderatorIdToUser User?     @relation("ContentModeration_moderatorIdToUser", fields: [moderatorId], references: [id])

  @@index([authorId])
  @@index([automatedScore])
  @@index([contentId])
  @@index([contentType])
  @@index([createdAt])
  @@index([status])
}

model ContentPage {
  id        String   @id @default(cuid())
  slug      String   @unique
  title     String
  excerpt   String?
  body      String?
  published Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model CoopSession {
  id                     String                   @id @default(cuid())
  partyId                String
  gameType               String
  gameId                 String?
  status                 String                   @default("active")
  settings               Json?
  progress               Json?
  startedAt              DateTime                 @default(now())
  endedAt                DateTime?
  createdAt              DateTime                 @default(now())
  updatedAt              DateTime                 @updatedAt
  Party                  Party                    @relation(fields: [partyId], references: [id], onDelete: Cascade)
  CoopSessionParticipant CoopSessionParticipant[]

  @@index([gameType])
  @@index([partyId])
  @@index([startedAt])
  @@index([status])
}

model CoopSessionParticipant {
  id          String      @id @default(cuid())
  sessionId   String
  userId      String
  role        String      @default("player")
  joinedAt    DateTime    @default(now())
  leftAt      DateTime?
  stats       Json?
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt
  CoopSession CoopSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  User        User        @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([sessionId, userId])
  @@index([sessionId])
  @@index([userId])
}

model Coupon {
  id                    String             @id @default(cuid())
  code                  String             @unique
  type                  String
  valueCents            Int
  enabled               Boolean            @default(true)
  startsAt              DateTime?
  endsAt                DateTime?
  maxRedemptions        Int?
  maxRedemptionsPerUser Int?
  minSubtotalCents      Int?
  allowedProductIds     String[]
  excludedProductIds    String[]
  allowedCollections    String[]
  excludedCollections   String[]
  stackable             Boolean            @default(false)
  oneTimeCode           Boolean            @default(false)
  createdAt             DateTime           @default(now())
  updatedAt             DateTime           @updatedAt
  CouponRedemption      CouponRedemption[]

  @@index([code])
  @@index([enabled])
}

model DiscountReward {
  id                    String        @id @default(cuid())
  name                  String // Display name for admin
  description           String? // Description shown to users
  discountType          DiscountType
  amountOff             Int? // Fixed amount off in cents
  percentOff            Int? // Percentage off (0-100)
  petalCost             Int // Cost in petals to unlock
  nsfwOnly              Boolean       @default(false) // Only applicable to NSFW products
  requiresAchievementId String? // Optional achievement requirement
  minSpendCents         Int? // Minimum order amount in cents
  maxUsesPerUser        Int? // Max times a user can purchase this reward
  maxTotalUses          Int? // Max total times this reward can be purchased
  validityDays          Int           @default(30) // How many days the coupon is valid after purchase
  enabled               Boolean       @default(true) // Whether this reward is available for purchase
  startsAt              DateTime? // When this reward becomes available
  endsAt                DateTime? // When this reward expires
  createdAt             DateTime      @default(now())
  updatedAt             DateTime      @updatedAt
  createdBy             String? // Admin user ID who created this
  CouponGrant           CouponGrant[]

  @@index([enabled])
  @@index([startsAt, endsAt])
  @@index([nsfwOnly])
}

model CouponGrant {
  id                    String          @id @default(cuid())
  userId                String
  code                  String          @unique
  discountType          DiscountType
  amountOff             Int?
  percentOff            Int?
  expiresAt             DateTime?
  petalCost             Int? // Original petal cost to unlock this discount
  nsfwOnly              Boolean         @default(false) // Only applicable to NSFW products
  requiresAchievementId String? // Optional achievement requirement
  minSpendCents         Int? // Minimum order amount in cents
  discountRewardId      String? // Reference to DiscountReward template if purchased from shop
  createdAt             DateTime        @default(now())
  updatedAt             DateTime        @updatedAt
  redeemedAt            DateTime?
  User                  User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  DiscountReward        DiscountReward? @relation(fields: [discountRewardId], references: [id], onDelete: SetNull)

  @@index([userId, redeemedAt])
  @@index([expiresAt])
  @@index([nsfwOnly])
  @@index([discountRewardId])
}

model CouponRedemption {
  id                String   @id @default(cuid())
  couponId          String
  clientReferenceId String
  status            String   @default("PENDING")
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  Coupon            Coupon   @relation(fields: [couponId], references: [id], onDelete: Cascade)

  @@unique([couponId, clientReferenceId])
  @@index([clientReferenceId])
  @@index([couponId])
  @@index([status])
}

model EmailLog {
  id        String    @id @default(cuid())
  userId    String?
  orderId   String?
  to        String
  provider  String    @default("resend")
  template  String
  status    String    @default("pending")
  meta      Json?
  sentAt    DateTime?
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  Order     Order?    @relation(fields: [orderId], references: [id])
  User      User?     @relation(fields: [userId], references: [id])

  @@index([orderId])
  @@index([sentAt])
  @@index([status])
  @@index([userId])
}

model Follow {
  followerId                   String
  followeeId                   String
  createdAt                    DateTime @default(now())
  User_Follow_followeeIdToUser User     @relation("Follow_followeeIdToUser", fields: [followeeId], references: [id], onDelete: Cascade)
  User_Follow_followerIdToUser User     @relation("Follow_followerIdToUser", fields: [followerId], references: [id], onDelete: Cascade)

  @@id([followerId, followeeId])
  @@index([followeeId])
  @@index([followerId])
}

model GameRun {
  id           String    @id @default(cuid())
  userId       String
  gameKey      String
  score        Int
  startedAt    DateTime  @default(now())
  finishedAt   DateTime?
  rewardPetals Int       @default(0)
  meta         Json?
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt
  User         User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, gameKey])
}

model GameSave {
  id        String   @id @default(cuid())
  userId    String
  gameId    String
  slot      Int      @default(1)
  payload   Json
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  User      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, gameId, slot])
  @@index([gameId])
  @@index([userId])
}

model GameSession {
  id        String    @id @default(cuid())
  gameId    String
  userId    String
  startTime DateTime
  endTime   DateTime?
  score     Int?
  highScore Int?
  actions   Json?
  metadata  Json?
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  User      User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([gameId])
  @@index([startTime])
  @@index([userId])
}

model GameSettings {
  id             String   @id @default(cuid())
  userId         String
  gameCode       String
  difficulty     String   @default("normal")
  soundEffects   Boolean  @default(true)
  music          Boolean  @default(true)
  hapticFeedback Boolean  @default(true)
  autoSave       Boolean  @default(true)
  customSettings Json?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  User           User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, gameCode])
  @@index([gameCode])
}

model GuestSession {
  id          String        @id @default(cuid())
  createdAt   DateTime      @default(now())
  lastSeenAt  DateTime      @default(now())
  updatedAt   DateTime      @updatedAt
  MergeLog    MergeLog[]
  PetalLedger PetalLedger[]

  @@index([createdAt])
  @@index([lastSeenAt])
}

model HomeRail {
  id           String    @id @default(cuid())
  key          String    @unique
  title        String
  productSlugs String[]  @default([]) @map("product_slugs")
  startsAt     DateTime? @map("starts_at")
  endsAt       DateTime? @map("ends_at")
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt @map("updated_at")

  @@index([key])
  @@index([startsAt, endsAt])
}

model IdempotencyKey {
  key       String   @id
  purpose   String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model InventoryItem {
  id         String        @id @default(cuid())
  userId     String
  sku        String
  kind       InventoryKind
  acquiredAt DateTime      @default(now())
  metadata   Json?
  createdAt  DateTime      @default(now())
  updatedAt  DateTime      @updatedAt
  User       User          @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, sku])
}

model Leaderboard {
  id               String             @id @default(cuid())
  gameCode         String
  scope            String             @default("global")
  period           String             @default("daily")
  createdAt        DateTime           @default(now())
  updatedAt        DateTime           @updatedAt
  LeaderboardScore LeaderboardScore[]

  @@index([createdAt])
  @@index([gameCode])
  @@index([period])
  @@index([scope])
}

model LeaderboardScore {
  id          String       @id @default(cuid())
  userId      String
  game        String
  diff        String?
  score       Int
  statsJson   Json?
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt
  boardId     String?
  meta        Json?
  profileId   String?
  rank        Int?
  Leaderboard Leaderboard? @relation(fields: [boardId], references: [id], onDelete: Cascade)
  User        User?        @relation(fields: [profileId], references: [id], onDelete: Cascade)

  @@unique([userId, game, diff])
  @@index([boardId])
  @@index([game, diff, score])
  @@index([profileId])
  @@index([rank])
}

model MergeLog {
  id                     String       @id @default(cuid())
  guestSessionId         String
  userId                 String
  mergedAt               DateTime     @default(now())
  guestPetalCountAtMerge Int
  userPetalCountBefore   Int
  userPetalCountAfter    Int
  createdAt              DateTime     @default(now())
  updatedAt              DateTime     @updatedAt
  GuestSession           GuestSession @relation(fields: [guestSessionId], references: [id], onDelete: Cascade)
  User                   User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([guestSessionId, userId])
  @@index([guestSessionId, mergedAt])
  @@index([userId, mergedAt])
}

model MessageTemplate {
  id                  String                @id @default(cuid())
  name                String                @unique
  pattern             String
  isActive            Boolean               @default(true)
  createdAt           DateTime              @default(now())
  updatedAt           DateTime              @updatedAt
  MessageTemplateSlot MessageTemplateSlot[]
}

model MessageTemplateSlot {
  id              String          @id @default(cuid())
  templateId      String
  position        Int
  optional        Boolean         @default(false)
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt
  MessageTemplate MessageTemplate @relation(fields: [templateId], references: [id])
  SlotAccepts     SlotAccepts[]

  @@unique([templateId, position])
}

model ModerationAction {
  id                                      String             @id @default(cuid())
  userId                                  String
  moderatorId                             String
  actionType                              String
  reason                                  String
  details                                 Json?
  reportId                                String?
  expiresAt                               DateTime?
  isActive                                Boolean            @default(true)
  createdAt                               DateTime           @default(now())
  updatedAt                               DateTime           @updatedAt
  appealedAt                              DateTime?
  appealStatus                            String             @default("none")
  User_ModerationAction_moderatorIdToUser User               @relation("ModerationAction_moderatorIdToUser", fields: [moderatorId], references: [id], onDelete: Cascade)
  UserReport                              UserReport?        @relation(fields: [reportId], references: [id])
  User_ModerationAction_userIdToUser      User               @relation("ModerationAction_userIdToUser", fields: [userId], references: [id], onDelete: Cascade)
  ModerationAppeal                        ModerationAppeal[]

  @@index([actionType])
  @@index([createdAt])
  @@index([expiresAt])
  @@index([isActive])
  @@index([moderatorId])
  @@index([userId])
}

model ModerationAppeal {
  id                                     String           @id @default(cuid())
  actionId                               String
  userId                                 String
  reason                                 String
  evidence                               Json?
  status                                 String           @default("pending")
  reviewedBy                             String?
  reviewNotes                            String?
  createdAt                              DateTime         @default(now())
  updatedAt                              DateTime         @updatedAt
  resolvedAt                             DateTime?
  ModerationAction                       ModerationAction @relation(fields: [actionId], references: [id], onDelete: Cascade)
  User_ModerationAppeal_reviewedByToUser User?            @relation("ModerationAppeal_reviewedByToUser", fields: [reviewedBy], references: [id])
  User_ModerationAppeal_userIdToUser     User             @relation("ModerationAppeal_userIdToUser", fields: [userId], references: [id], onDelete: Cascade)

  @@index([actionId])
  @@index([createdAt])
  @@index([status])
  @@index([userId])
}

model ModeratorRole {
  id                                  String    @id @default(cuid())
  userId                              String
  role                                String
  permissions                         Json
  assignedBy                          String
  isActive                            Boolean   @default(true)
  createdAt                           DateTime  @default(now())
  updatedAt                           DateTime  @updatedAt
  expiresAt                           DateTime?
  User_ModeratorRole_assignedByToUser User      @relation("ModeratorRole_assignedByToUser", fields: [assignedBy], references: [id], onDelete: Cascade)
  User_ModeratorRole_userIdToUser     User      @relation("ModeratorRole_userIdToUser", fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, role])
  @@index([isActive])
  @@index([role])
  @@index([userId])
}

model MusicPlaylist {
  id         String       @id @default(cuid())
  name       String
  isPublic   Boolean      @default(true)
  createdBy  String
  createdAt  DateTime     @default(now())
  updatedAt  DateTime     @updatedAt
  MusicTrack MusicTrack[]
}

model MusicTrack {
  id            String        @id @default(cuid())
  playlistId    String
  title         String
  artist        String
  url           String
  sort          Int
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt
  MusicPlaylist MusicPlaylist @relation(fields: [playlistId], references: [id], onDelete: Cascade)

  @@index([playlistId, sort])
}

model Notification {
  id        String   @id @default(cuid())
  profileId String
  type      String
  payload   Json
  read      Boolean  @default(false)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  User      User     @relation(fields: [profileId], references: [id], onDelete: Cascade)

  @@index([createdAt])
  @@index([profileId])
  @@index([read])
  @@index([type])
}

model Order {
  id                 String             @id @default(cuid())
  userId             String
  stripeId           String             @unique
  paymentIntentId    String?
  chargeId           String?
  status             OrderStatus        @default(pending)
  totalAmount        Int
  currency           String             @default("USD")
  shippedAt          DateTime?
  trackingUrl        String?
  carrier            String?
  trackingNumber     String?
  createdAt          DateTime           @default(now())
  updatedAt          DateTime           @updatedAt
  paidAt             DateTime?
  petalsAwarded      Int                @default(0)
  printifyId         String?
  memoryCardKey      String?
  displayNumber      Int                @unique @default(autoincrement())
  primaryItemName    String?            @default("")
  label              String?            @default("")
  subtotalCents      Int                @default(0)
  appliedCouponCodes String[]           @default([])
  EmailLog           EmailLog[]
  User               User               @relation(fields: [userId], references: [id])
  OrderItem          OrderItem[]
  PrintifyOrderSync  PrintifyOrderSync?
  RewardLedger       RewardLedger[]
  UserRune           UserRune[]
}

model OrderItem {
  id                String         @id @default(cuid())
  orderId           String
  productId         String
  productVariantId  String
  sku               String
  name              String
  quantity          Int
  unitAmount        Int
  printifyProductId String?
  printifyVariantId Int?
  upc               String?
  createdAt         DateTime       @default(now())
  updatedAt         DateTime       @updatedAt
  Order             Order          @relation(fields: [orderId], references: [id], onDelete: Cascade)
  Product           Product        @relation(fields: [productId], references: [id])
  ProductVariant    ProductVariant @relation(fields: [productVariantId], references: [id])

  @@index([orderId])
  @@index([printifyVariantId])
  @@index([upc])
}

model Party {
  id              String            @id @default(cuid())
  name            String
  description     String?
  leaderId        String
  maxMembers      Int               @default(4)
  isPublic        Boolean           @default(true)
  gameMode        String?
  status          String            @default("open")
  settings        Json?
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt
  CoopSession     CoopSession[]
  User            User              @relation(fields: [leaderId], references: [id], onDelete: Cascade)
  PartyInvitation PartyInvitation[]
  PartyMember     PartyMember[]
  PartyMessage    PartyMessage[]

  @@index([createdAt])
  @@index([gameMode])
  @@index([isPublic])
  @@index([leaderId])
  @@index([status])
}

model PartyInvitation {
  id                                   String    @id @default(cuid())
  partyId                              String
  inviterId                            String
  inviteeId                            String
  status                               String    @default("pending")
  message                              String?
  expiresAt                            DateTime
  createdAt                            DateTime  @default(now())
  updatedAt                            DateTime  @updatedAt
  respondedAt                          DateTime?
  User_PartyInvitation_inviteeIdToUser User      @relation("PartyInvitation_inviteeIdToUser", fields: [inviteeId], references: [id], onDelete: Cascade)
  User_PartyInvitation_inviterIdToUser User      @relation("PartyInvitation_inviterIdToUser", fields: [inviterId], references: [id], onDelete: Cascade)
  Party                                Party     @relation(fields: [partyId], references: [id], onDelete: Cascade)

  @@unique([partyId, inviteeId])
  @@index([expiresAt])
  @@index([inviteeId])
  @@index([inviterId])
  @@index([partyId])
  @@index([status])
}

model PartyMember {
  id           String   @id @default(cuid())
  partyId      String
  userId       String
  role         String   @default("member")
  joinedAt     DateTime @default(now())
  lastActiveAt DateTime @default(now())
  permissions  Json?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  Party        Party    @relation(fields: [partyId], references: [id], onDelete: Cascade)
  User         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([partyId, userId])
  @@index([partyId])
  @@index([role])
  @@index([userId])
}

model PartyMessage {
  id          String   @id @default(cuid())
  partyId     String
  authorId    String
  content     String
  messageType String   @default("text")
  metadata    Json?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  User        User     @relation(fields: [authorId], references: [id], onDelete: Cascade)
  Party       Party    @relation(fields: [partyId], references: [id], onDelete: Cascade)

  @@index([authorId])
  @@index([createdAt])
  @@index([partyId])
}

model PetalCollection {
  id              String   @id @default(cuid())
  userId          String?
  count           Int
  positionX       Float
  positionY       Float
  isAuthenticated Boolean  @default(false)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([createdAt])
  @@index([isAuthenticated])
  @@index([userId])
}

model PetalLedger {
  id             String        @id @default(cuid())
  userId         String?
  type           LedgerType
  amount         Int
  reason         String
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt
  guestSessionId String?
  GuestSession   GuestSession? @relation(fields: [guestSessionId], references: [id], onDelete: Cascade)
  User           User?         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([guestSessionId, createdAt])
  @@index([guestSessionId, type, createdAt])
  @@index([userId, createdAt])
  @@index([userId, type, createdAt])
}

model PetalShopItem {
  id          String    @id @default(cuid())
  sku         String    @unique
  name        String
  kind        String
  priceRunes  Int?
  pricePetals Int?
  eventTag    String?
  visibleFrom DateTime?
  visibleTo   DateTime?
  metadata    Json?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@index([eventTag])
  @@index([kind])
  @@index([visibleFrom, visibleTo])
}

model PetalTransaction {
  id          String   @id @default(cuid())
  userId      String
  amount      Int
  source      String
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  User        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([createdAt])
  @@index([source])
  @@index([userId])
}

model PetalWallet {
  id              String    @id @default(cuid())
  userId          String    @unique
  balance         Int       @default(0)
  lifetimeEarned  Int       @default(0)
  currentStreak   Int       @default(0)
  lastCollectedAt DateTime?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  User            User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model Phrase {
  id              String            @id @default(cuid())
  category        PhraseCategory
  text            String
  locale          String?           @default("en")
  isActive        Boolean           @default(true)
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt
  CommentFragment CommentFragment[]

  @@unique([category, text, locale])
}

model Post {
  id          String        @id @default(cuid())
  title       String
  slug        String        @unique
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt
  CommentMark CommentMark[]
}

model Praise {
  id        String   @id @default(cuid())
  userId    String
  targetId  String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  User      User     @relation("Praise_userId", fields: [userId], references: [id], onDelete: Cascade)
  Target    User     @relation("Praise_targetId", fields: [targetId], references: [id], onDelete: Cascade)

  @@unique([userId, targetId])
  @@index([userId])
  @@index([targetId])
}

model Presence {
  profileId    String   @id
  status       String   @default("online")
  lastSeen     DateTime @default(now())
  activity     Json     @default("{}")
  showActivity Boolean  @default(true)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  User         User     @relation(fields: [profileId], references: [id], onDelete: Cascade)

  @@index([lastSeen])
  @@index([status])
}

model PrintifyOrderSync {
  id              String    @id @default(cuid())
  localOrderId    String    @unique
  printifyOrderId String
  status          String
  lastSyncAt      DateTime?
  error           String?   @db.VarChar(500)
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  Order           Order     @relation(fields: [localOrderId], references: [id], onDelete: Cascade)

  @@index([localOrderId])
  @@index([status])
}

model PrivacySettings {
  id                    String   @id @default(cuid())
  userId                String   @unique
  showOnlineStatus      Boolean  @default(true)
  showLastSeen          Boolean  @default(true)
  showActivity          Boolean  @default(true)
  showAchievements      Boolean  @default(true)
  showLeaderboardScores Boolean  @default(true)
  showPartyActivity     Boolean  @default(true)
  showPurchaseHistory   Boolean  @default(false)
  allowSearchIndexing   Boolean  @default(true)
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt
  User                  User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model Product {
  id                String             @id @default(cuid())
  name              String
  description       String?
  primaryImageUrl   String?
  stripeProductId   String?            @unique
  printifyProductId String?            @unique
  active            Boolean            @default(true)
  category          String?
  isNSFW            Boolean            @default(false)
  categorySlug      String?            @map("category_slug")
  integrationRef    String?            @unique @map("integration_ref")
  visible           Boolean            @default(true)
  blueprintId       Int?
  printProviderId   Int?
  tags              String[]           @default([])
  options           Json?
  specs             Json?
  lastSyncedAt      DateTime?          @map("last_synced_at")
  createdAt         DateTime           @default(now()) @map("created_at")
  updatedAt         DateTime           @updatedAt @map("updated_at")
  CartItem          CartItem[]
  OrderItem         OrderItem[]
  ProductSoapstone  ProductSoapstone[]
  ProductVariant    ProductVariant[]
  ProductImage      ProductImage[]
  Review            Review[]
  Wishlist          Wishlist[]

  @@index([active, categorySlug])
  @@index([categorySlug])
  @@index([createdAt])
  @@index([integrationRef])
  @@index([updatedAt])
  @@index([printifyProductId])
}

model ProductReview {
  id         String   @id @default(cuid())
  productId  String
  userId     String
  rating     Int
  title      String?
  body       String
  imageUrls  String[]
  isApproved Boolean  @default(false)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@index([isApproved, createdAt])
  @@index([productId, createdAt])
}

model ProductSoapstone {
  id                     String                   @id @default(cuid())
  productId              String
  authorId               String
  text                   String
  status                 Visibility               @default(PUBLIC)
  appraises              Int                      @default(0)
  reports                Int                      @default(0)
  x                      Int?
  y                      Int?
  createdAt              DateTime                 @default(now())
  updatedAt              DateTime                 @updatedAt
  Product                Product                  @relation(fields: [productId], references: [id], onDelete: Cascade)
  User                   User                     @relation(fields: [authorId], references: [id], onDelete: Cascade)
  ProductSoapstonePraise ProductSoapstonePraise[]

  @@index([productId])
  @@index([authorId])
  @@index([status])
}

model ProductSoapstonePraise {
  id               String           @id @default(cuid())
  userId           String
  soapstoneId      String
  createdAt        DateTime         @default(now())
  updatedAt        DateTime         @updatedAt
  User             User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  ProductSoapstone ProductSoapstone @relation(fields: [soapstoneId], references: [id], onDelete: Cascade)

  @@unique([userId, soapstoneId])
  @@index([userId])
  @@index([soapstoneId])
}

model ProductVariant {
  id                String      @id @default(cuid())
  productId         String
  previewImageUrl   String?
  printifyVariantId Int
  printProviderName String?
  title             String?
  sku               String?
  grams             Int?
  leadMinDays       Int?
  leadMaxDays       Int?
  isEnabled         Boolean     @default(true)
  inStock           Boolean     @default(true)
  priceCents        Int?
  currency          String?     @default("USD")
  stripePriceId     String?     @unique
  isDefaultVariant  Boolean     @default(false)
  optionValues      Json?
  costCents         Int?
  lastSyncedAt      DateTime?   @map("last_synced_at")
  createdAt         DateTime    @default(now())
  updatedAt         DateTime    @updatedAt
  CartItem          CartItem[]
  OrderItem         OrderItem[]
  Product           Product     @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@unique([productId, printifyVariantId])
  @@index([printifyVariantId])
  @@index([stripePriceId])
  @@index([productId, isDefaultVariant])
}

model ProductImage {
  id         String   @id @default(uuid())
  productId  String
  url        String
  position   Int      @default(0)
  variantIds Int[]
  isDefault  Boolean  @default(false)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  Product    Product  @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@unique([productId, url])
  @@index([productId, position])
}

model ProductView {
  id        String   @id @default(cuid())
  productId String
  userId    String?
  ipAddress String?
  userAgent String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([productId, createdAt])
  @@index([userId, createdAt])
}

model Profile {
  id        String   @id @default(cuid())
  userId    String   @unique
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  User      User     @relation(fields: [userId], references: [id])
}

model ProfileLink {
  id        String   @id @default(cuid())
  profileId String
  label     String
  url       String
  orderIdx  Int      @default(0)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  User      User     @relation(fields: [profileId], references: [id], onDelete: Cascade)

  @@index([orderIdx])
  @@index([profileId])
}

model ProfileSection {
  id        String   @id @default(cuid())
  profileId String
  code      String
  orderIdx  Int
  visible   Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  User      User     @relation(fields: [profileId], references: [id], onDelete: Cascade)

  @@index([orderIdx])
  @@index([profileId])
}

model ProfileTheme {
  profileId String   @id
  themeCode String   @default("glass_pink")
  accentHex String   @default("#ec4899")
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  User      User     @relation(fields: [profileId], references: [id], onDelete: Cascade)
}

model Quest {
  id              String            @id @default(cuid())
  key             String            @unique
  title           String
  description     String
  kind            String
  basePetals      Int               @default(20)
  bonusPetals     Int               @default(10)
  active          Boolean           @default(true)
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt
  QuestAssignment QuestAssignment[]
}

model QuestAssignment {
  id            String    @id @default(cuid())
  userId        String
  questId       String
  day           String
  progress      Int       @default(0)
  target        Int       @default(1)
  completedAt   DateTime?
  claimedAt     DateTime?
  bonusEligible Boolean   @default(true)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  Quest         Quest     @relation(fields: [questId], references: [id])
  User          User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, questId, day])
  @@index([questId, day])
  @@index([userId, day])
}

model Reaction {
  id               String           @id @default(cuid())
  messageId        String
  userId           String
  type             ReactionType
  createdAt        DateTime         @default(now())
  updatedAt        DateTime         @updatedAt
  SoapstoneMessage SoapstoneMessage @relation(fields: [messageId], references: [id], onDelete: Cascade)

  @@unique([messageId, userId, type])
}

model Review {
  id         String   @id @default(cuid())
  productId  String
  userId     String
  rating     Int
  title      String?
  body       String?
  images     Json     @default("[]")
  isApproved Boolean  @default(false) @map("is_approved")
  createdAt  DateTime @default(now()) @map("created_at")
  updatedAt  DateTime @updatedAt @map("updated_at")
  Product    Product  @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@index([createdAt])
  @@index([isApproved])
  @@index([productId])
  @@index([userId])
}

model Reward {
  id          String        @id @default(cuid())
  kind        RewardKind
  sku         String?
  value       Int?
  metadata    Json?
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt
  Achievement Achievement[]

  @@index([kind])
  @@index([sku])
}

model RewardLedger {
  id           String   @id @default(cuid())
  userId       String?
  orderId      String?
  type         String
  amount       Int
  balanceAfter Int
  metadata     Json?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  Order        Order?   @relation(fields: [orderId], references: [id])
  User         User?    @relation(fields: [userId], references: [id])

  @@index([orderId])
  @@index([userId, createdAt])
}

model Rune {
  id          String       @id @default(cuid())
  slug        String       @unique
  name        String
  description String
  power       Int          @default(50)
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt
  RuneUnlock  RuneUnlock[]

  @@index([power])
  @@index([slug])
}

model RuneCombo {
  id              String            @id @default(cuid())
  comboId         String            @unique
  members         String[]
  revealCopy      String?
  cosmeticBurst   String?
  isActive        Boolean           @default(true)
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt
  RuneComboMember RuneComboMember[]

  @@index([comboId])
  @@index([isActive])
}

model RuneComboMember {
  id        String    @id @default(cuid())
  comboId   String
  runeId    String
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  RuneCombo RuneCombo @relation(fields: [comboId], references: [id], onDelete: Cascade)
  RuneDef   RuneDef   @relation(fields: [runeId], references: [id], onDelete: Cascade)

  @@unique([comboId, runeId])
  @@index([comboId])
  @@index([runeId])
}

model RuneDef {
  id              String            @id @default(cuid())
  canonicalId     String            @unique
  displayName     String?
  glyph           String?
  lore            String?
  printifyUPCs    String[]
  isActive        Boolean           @default(true)
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt
  RuneComboMember RuneComboMember[]
  UserRune        UserRune[]

  @@index([canonicalId])
  @@index([isActive])
}

model RuneUnlock {
  id         String   @id @default(cuid())
  userId     String
  slug       String
  unlockedAt DateTime @default(now())
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  Rune       Rune     @relation(fields: [slug], references: [slug], onDelete: Cascade)

  @@unique([userId, slug])
  @@index([slug])
  @@index([unlockedAt])
  @@index([userId])
}

model SearchAnalytics {
  id                String   @id @default(cuid())
  query             String
  searchType        String
  resultCount       Int
  clickedResultId   String?
  clickedResultType String?
  sessionId         String?
  userId            String?
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  User              User?    @relation(fields: [userId], references: [id])

  @@index([createdAt])
  @@index([query])
  @@index([searchType])
  @@index([userId])
}

model SearchHistory {
  id          String   @id @default(cuid())
  userId      String
  query       String
  searchType  String
  filters     Json?
  resultCount Int?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  User        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([createdAt])
  @@index([query])
  @@index([searchType])
  @@index([userId])
}

model SearchSuggestion {
  id             String    @id @default(cuid())
  query          String
  suggestionType String
  targetId       String?
  targetType     String?
  popularity     Int       @default(0)
  lastUsed       DateTime?
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  @@unique([query, suggestionType, targetId])
  @@index([lastUsed])
  @@index([popularity])
  @@index([query])
  @@index([suggestionType])
}

model ShopItem {
  id          String    @id @default(cuid())
  sku         String    @unique
  name        String
  kind        String
  priceRunes  Int?
  pricePetals Int?
  eventTag    String?
  visibleFrom DateTime?
  visibleTo   DateTime?
  metadata    Json?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@index([eventTag])
  @@index([kind])
  @@index([visibleFrom, visibleTo])
}

model SiteConfig {
  id        String   @id @default("singleton")
  guestCap  Int      @default(50)
  burst     Json     @default("{\"enabled\": true, \"maxPerMinute\": 3, \"particleCount\": {\"large\": 80, \"small\": 20, \"medium\": 40}, \"rarityWeights\": {\"large\": 0.1, \"small\": 0.6, \"medium\": 0.3}, \"minCooldownSec\": 15}")
  tree      Json     @default("{\"sway\": 0.5, \"dither\": 0.3, \"snapPx\": 4, \"spawnRate\": 2000}")
  theme     Json     @default("{\"grayIntensity\": 0.8, \"pinkIntensity\": 0.7, \"motionIntensity\": 2}")
  seasonal  Json     @default("{\"autumnMode\": false, \"springMode\": false, \"sakuraBoost\": false}")
  rewards   Json     @default("{\"daily\": {\"hardCap\": 400, \"softCap\": 200, \"postSoftRatePct\": 0.5}, \"streak\": {\"maxPct\": 0.25, \"enabled\": true, \"dailyBonusPct\": 0.05}, \"seasonal\": {\"multiplier\": 1.0}, \"maxPerOrder\": 120, \"minPerOrder\": 5, \"baseRateCents\": 300, \"firstPurchaseBonus\": 20}")
  runes     Json     @default("{\"defs\": [], \"gacha\": {\"enabled\": false}, \"combos\": []}")
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  updatedBy String?
}

model SiteSetting {
  id          String   @id @default(cuid())
  key         String   @unique
  boolValue   Boolean?
  stringValue String?
  jsonValue   Json?
  updatedAt   DateTime @updatedAt
  updatedBy   String?

  @@index([key])
}

model SlotAccepts {
  id                  String              @id @default(cuid())
  slotId              String
  category            PhraseCategory
  createdAt           DateTime            @default(now())
  updatedAt           DateTime            @updatedAt
  MessageTemplateSlot MessageTemplateSlot @relation(fields: [slotId], references: [id])

  @@unique([slotId, category])
  @@index([category])
}

model Soapstone {
  id            String          @id @default(cuid())
  userId        String
  text          String
  score         Int             @default(0)
  createdAt     DateTime        @default(now())
  updatedAt     DateTime        @updatedAt
  User          User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  SoapstoneVote SoapstoneVote[]

  @@index([createdAt])
  @@index([score])
  @@index([userId])
}

model SoapstoneMessage {
  id         String     @id @default(cuid())
  createdAt  DateTime   @default(now())
  appraises  Int        @default(0)
  authorId   String
  overlayURL String?
  postId     String?
  reports    Int        @default(0)
  status     Visibility @default(PUBLIC)
  text       String
  updatedAt  DateTime   @updatedAt
  x          Int?
  y          Int?
  Reaction   Reaction[]
  User       User       @relation(fields: [authorId], references: [id], onDelete: Cascade)

  @@index([authorId])
  @@index([postId])
}

model SoapstoneVote {
  id          String    @id @default(cuid())
  userId      String
  soapstoneId String
  vote        String
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  Soapstone   Soapstone @relation(fields: [soapstoneId], references: [id], onDelete: Cascade)
  User        User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, soapstoneId])
  @@index([soapstoneId])
  @@index([userId])
}

model StreakShard {
  id        String   @id @default(cuid())
  userId    String
  day       String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  User      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, day])
  @@index([userId, day])
}

model StripeCustomer {
  id         String   @id @default(cuid())
  userId     String   @unique
  customerId String   @unique
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  User       User     @relation(fields: [userId], references: [id])
}

model User {
  id                                                    String                   @id @default(cuid())
  email                                                 String                   @unique
  username                                              String                   @unique
  displayName                                           String?                  @map("display_name")
  avatarUrl                                             String?
  createdAt                                             DateTime                 @default(now())
  petalBalance                                          Int                      @default(0)
  hideRewardsExplainer                                  Boolean                  @default(false)
  activeCosmetic                                        String?
  activeOverlay                                         String?
  clerkId                                               String                   @unique
  dailyClicks                                           Int                      @default(0)
  lastClickDayUTC                                       DateTime                 @default(now())
  level                                                 Int                      @default(1)
  runes                                                 Int                      @default(0)
  xp                                                    Int                      @default(0)
  nsfwAffirmationVer                                    Int                      @default(1)
  nsfwAffirmedAt                                        DateTime?
  nsfwEnabled                                           Boolean                  @default(true)
  bannerUrl                                             String?
  bio                                                   String?
  location                                              String?
  visibility                                            String                   @default("public")
  website                                               String?
  avatarBundle                                          Json?
  avatarConfig                                          Json?
  avatarRendering                                       Json?
  updatedAt                                             DateTime                 @updatedAt
  Activity                                              Activity[]
  Appraisal                                             Appraisal[]
  AvatarConfiguration                                   AvatarConfiguration[]
  Block_Block_blockedIdToUser                           Block[]                  @relation("Block_blockedIdToUser")
  Block_Block_blockerIdToUser                           Block[]                  @relation("Block_blockerIdToUser")
  Cart                                                  Cart?
  CharacterConfig                                       CharacterConfig[]
  Comment                                               Comment[]
  CommentLike                                           CommentLike[]
  CommentMark                                           CommentMark[]
  CommentModeration                                     CommentModeration[]
  CommentReport_CommentReport_moderatorIdToUser         CommentReport[]          @relation("CommentReport_moderatorIdToUser")
  CommentReport_CommentReport_reporterIdToUser          CommentReport[]          @relation("CommentReport_reporterIdToUser")
  ContactMessage                                        ContactMessage[]
  ContentModeration_ContentModeration_authorIdToUser    ContentModeration[]      @relation("ContentModeration_authorIdToUser")
  ContentModeration_ContentModeration_moderatorIdToUser ContentModeration[]      @relation("ContentModeration_moderatorIdToUser")
  CoopSessionParticipant                                CoopSessionParticipant[]
  CouponGrant                                           CouponGrant[]
  EmailLog                                              EmailLog[]
  Follow_Follow_followeeIdToUser                        Follow[]                 @relation("Follow_followeeIdToUser")
  Follow_Follow_followerIdToUser                        Follow[]                 @relation("Follow_followerIdToUser")
  GameRun                                               GameRun[]
  GameSave                                              GameSave[]
  GameSession                                           GameSession[]
  GameSettings                                          GameSettings[]
  InventoryItem                                         InventoryItem[]
  LeaderboardScore                                      LeaderboardScore[]
  MergeLog                                              MergeLog[]
  ModerationAction_ModerationAction_moderatorIdToUser   ModerationAction[]       @relation("ModerationAction_moderatorIdToUser")
  ModerationAction_ModerationAction_userIdToUser        ModerationAction[]       @relation("ModerationAction_userIdToUser")
  ModerationAppeal_ModerationAppeal_reviewedByToUser    ModerationAppeal[]       @relation("ModerationAppeal_reviewedByToUser")
  ModerationAppeal_ModerationAppeal_userIdToUser        ModerationAppeal[]       @relation("ModerationAppeal_userIdToUser")
  ModeratorRole_ModeratorRole_assignedByToUser          ModeratorRole[]          @relation("ModeratorRole_assignedByToUser")
  ModeratorRole_ModeratorRole_userIdToUser              ModeratorRole[]          @relation("ModeratorRole_userIdToUser")
  Notification                                          Notification[]
  Order                                                 Order[]
  Party                                                 Party[]
  PartyInvitation_PartyInvitation_inviteeIdToUser       PartyInvitation[]        @relation("PartyInvitation_inviteeIdToUser")
  PartyInvitation_PartyInvitation_inviterIdToUser       PartyInvitation[]        @relation("PartyInvitation_inviterIdToUser")
  PartyMember                                           PartyMember[]
  PartyMessage                                          PartyMessage[]
  PetalLedger                                           PetalLedger[]
  PetalTransaction                                      PetalTransaction[]
  PetalWallet                                           PetalWallet?
  Praise_sent                                           Praise[]                 @relation("Praise_userId")
  Praise_received                                       Praise[]                 @relation("Praise_targetId")
  Presence                                              Presence?
  PrivacySettings                                       PrivacySettings?
  ProductSoapstone                                      ProductSoapstone[]
  ProductSoapstonePraise                                ProductSoapstonePraise[]
  Profile                                               Profile?
  ProfileLink                                           ProfileLink[]
  ProfileSection                                        ProfileSection[]
  ProfileTheme                                          ProfileTheme?
  QuestAssignment                                       QuestAssignment[]
  RewardLedger                                          RewardLedger[]
  SearchAnalytics                                       SearchAnalytics[]
  SearchHistory                                         SearchHistory[]
  Soapstone                                             Soapstone[]
  SoapstoneMessage                                      SoapstoneMessage[]
  SoapstoneVote                                         SoapstoneVote[]
  StreakShard                                           StreakShard[]
  StripeCustomer                                        StripeCustomer?
  UserAchievement                                       UserAchievement[]
  UserCharacterPreset                                   UserCharacterPreset[]
  UserFile                                              UserFile[]
  UserProfile                                           UserProfile?
  UserReport_UserReport_assignedModeratorIdToUser       UserReport[]             @relation("UserReport_assignedModeratorIdToUser")
  UserReport_UserReport_reportedUserIdToUser            UserReport[]             @relation("UserReport_reportedUserIdToUser")
  UserReport_UserReport_reporterIdToUser                UserReport[]             @relation("UserReport_reporterIdToUser")
  UserRune                                              UserRune[]
  UserSafetySettings                                    UserSafetySettings?
  UserSettings                                          UserSettings?
  UserTitle                                             UserTitle[]
  Wallet                                                Wallet?
  Wishlist                                              Wishlist[]

  @@index([clerkId])
}

model UserAchievement {
  id            String      @id @default(cuid())
  userId        String
  achievementId String
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt
  Achievement   Achievement @relation(fields: [achievementId], references: [id], onDelete: Cascade)
  User          User        @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, achievementId])
}

model UserCharacterPreset {
  id              String          @id @default(cuid())
  userId          String
  presetId        String
  unlockedAt      DateTime        @default(now())
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt
  CharacterPreset CharacterPreset @relation(fields: [presetId], references: [id], onDelete: Cascade)
  User            User            @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, presetId])
  @@index([presetId])
  @@index([userId])
}

model UserFile {
  id        String   @id @default(cuid())
  userId    String
  key       String   @unique
  url       String
  size      Int
  mimeType  String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  User      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, createdAt])
  @@index([userId])
}

model UserProfile {
  id                String    @id @default(cuid())
  userId            String    @unique
  gamertag          String?
  gamertagChangedAt DateTime?
  bannerKey         String?
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
  User              User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model UserReport {
  id                                        String             @id @default(cuid())
  reporterId                                String
  reportedUserId                            String?
  contentType                               String
  contentId                                 String?
  reason                                    String
  description                               String?
  evidence                                  Json?
  status                                    String             @default("pending")
  priority                                  String             @default("medium")
  assignedModeratorId                       String?
  moderatorNotes                            String?
  resolution                                String?
  createdAt                                 DateTime           @default(now())
  updatedAt                                 DateTime           @updatedAt
  resolvedAt                                DateTime?
  ModerationAction                          ModerationAction[]
  User_UserReport_assignedModeratorIdToUser User?              @relation("UserReport_assignedModeratorIdToUser", fields: [assignedModeratorId], references: [id])
  User_UserReport_reportedUserIdToUser      User?              @relation("UserReport_reportedUserIdToUser", fields: [reportedUserId], references: [id])
  User_UserReport_reporterIdToUser          User               @relation("UserReport_reporterIdToUser", fields: [reporterId], references: [id], onDelete: Cascade)

  @@index([assignedModeratorId])
  @@index([contentId])
  @@index([contentType])
  @@index([createdAt])
  @@index([priority])
  @@index([reportedUserId])
  @@index([reporterId])
  @@index([status])
}

model UserRune {
  id         String   @id @default(cuid())
  userId     String
  runeId     String
  orderId    String?
  acquiredAt DateTime @default(now())
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  Order      Order?   @relation(fields: [orderId], references: [id])
  RuneDef    RuneDef  @relation(fields: [runeId], references: [id], onDelete: Cascade)
  User       User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, runeId])
  @@index([orderId])
  @@index([runeId])
  @@index([userId, acquiredAt])
}

model UserSafetySettings {
  id                      String   @id @default(cuid())
  userId                  String   @unique
  allowFriendRequests     Boolean  @default(true)
  allowPartyInvites       Boolean  @default(true)
  allowMessages           Boolean  @default(true)
  blockedUsers            String[]
  contentFilter           String   @default("moderate")
  reportNotifications     Boolean  @default(true)
  moderationNotifications Boolean  @default(true)
  createdAt               DateTime @default(now())
  updatedAt               DateTime @updatedAt
  User                    User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model UserSettings {
  id                      String   @id @default(cuid())
  userId                  String   @unique
  profileVisibility       String   @default("public")
  allowFriendRequests     Boolean  @default(true)
  allowPartyInvites       Boolean  @default(true)
  allowMessages           Boolean  @default(true)
  activityVisibility      String   @default("public")
  leaderboardOptOut       Boolean  @default(false)
  notificationPreferences Json     @default("{\"push\": true, \"email\": true, \"inApp\": true, \"comments\": true, \"activities\": true, \"achievements\": true, \"leaderboards\": true, \"partyInvites\": true, \"friendRequests\": true}")
  contentFilter           String   @default("moderate")
  language                String   @default("en")
  timezone                String   @default("UTC")
  theme                   String   @default("auto")
  motionReduced           Boolean  @default(false)
  soundEnabled            Boolean  @default(true)
  musicEnabled            Boolean  @default(true)
  createdAt               DateTime @default(now())
  updatedAt               DateTime @updatedAt
  User                    User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([activityVisibility])
  @@index([profileVisibility])
}

model UserTitle {
  id        String   @id @default(cuid())
  userId    String
  title     String
  awardedAt DateTime @default(now())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  User      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, awardedAt])
  @@index([userId])
}

model Wallet {
  id        String   @id @default(cuid())
  userId    String   @unique
  petals    Int      @default(0)
  runes     Int      @default(0)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  User      User     @relation(fields: [userId], references: [id])
}

model WebhookEvent {
  id        String   @id @default(cuid())
  type      String
  payload   Json
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Wishlist {
  id        String   @id @default(cuid())
  userId    String
  productId String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  Product   Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
  User      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, productId])
  @@index([productId])
  @@index([userId])
}

enum AppraisalValue {
  GOOD
  POOR
}

enum CommentKind {
  SOAPSTONE
  TEXT
  HYBRID
}

enum CommentStatus {
  ACTIVE
  HIDDEN
  SHADOWBANNED
  DELETED
}

enum DiscountType {
  PERCENT
  OFF_AMOUNT
}

enum InventoryKind {
  COSMETIC
  OVERLAY
  TEXT
  CURSOR
}

enum LedgerType {
  earn
  spend
  adjust
  burst_bonus
  seasonal
  purchase_bonus
  first_purchase_bonus
  milestone_bonus
  combo_reveal
  preset_unlock
}

enum OrderStatus {
  pending
  pending_mapping
  in_production
  shipped
  cancelled
}

enum PhraseCategory {
  TIP
  SUBJECT
  ACTION
  DIRECTION
  OBJECT
  QUALITY
  CONJUNCTION
  EMOTE
  ELEMENT
  ATTACK_TYPE
  PLACE
  TIME
  MEME
  HUMOR
}

enum ReactionType {
  APPRAISE
  DOWNVOTE
  LAUGH
  HEART
  FIRE
  SKULL
}

enum RewardKind {
  PETALS_BONUS
  COSMETIC
  OVERLAY
  COUPON_PERCENT
  COUPON_AMOUNT
  RUNE_GRANT
  TRACK_UNLOCK
}

enum SoapstoneStatus {
  PENDING
  APPROVED
  REJECTED
  FLAGGED
}

enum Visibility {
  PUBLIC
  HIDDEN
  REMOVED
}
